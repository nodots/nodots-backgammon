<!DOCTYPE html>
<html>
<head>
    <title>Robot Roll History Verification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        .dice { background: #f0f0f0; padding: 4px 8px; border-radius: 4px; margin: 2px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üéØ Robot Roll History Fix Verification</h1>
    
    <div id="status">Loading...</div>
    
    <div id="results"></div>
    
    <script>
        async function verifyRobotHistoryFix() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            try {
                statusDiv.innerHTML = 'üîÑ Creating new game to test robot roll history...';
                
                // Create a new human vs robot game
                const createResponse = await fetch('/api/v3.7/games/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        player1: { userId: 'test-human-browser' },
                        player2: { userId: 'test-robot-browser', isRobot: true }
                    })
                });
                
                if (!createResponse.ok) {
                    throw new Error(`Game creation failed: ${createResponse.status}`);
                }
                
                const gameData = await createResponse.json();
                const gameId = gameData.game.id;
                
                statusDiv.innerHTML = `‚úÖ Game created: ${gameId}<br>‚è≥ Waiting for robot to complete first turn...`;
                
                // Wait for robot automation to complete
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Fetch game history
                statusDiv.innerHTML = `üîç Checking game history for robot rolls...`;
                
                const historyResponse = await fetch(`/api/v3.7/games/${gameId}/history`);
                if (!historyResponse.ok) {
                    throw new Error(`History fetch failed: ${historyResponse.status}`);
                }
                
                const historyData = await historyResponse.json();
                
                // Find robot roll actions
                const robotRolls = historyData.actions.filter(action => 
                    action.actionType === 'roll-dice' && 
                    action.playerId !== 'test-human-browser'
                );
                
                let results = `<h2>üìä Results</h2>`;
                results += `<p><strong>Total history actions:</strong> ${historyData.actions.length}</p>`;
                results += `<p><strong>Robot roll actions found:</strong> ${robotRolls.length}</p>`;
                
                if (robotRolls.length > 0) {
                    results += `<div class="success">‚úÖ SUCCESS: Robot rolls are being recorded!</div>`;
                    
                    results += `<h3>ü§ñ Robot Roll Details:</h3>`;
                    robotRolls.forEach((action, index) => {
                        const dice = action.actionData?.rollDice?.dice || [];
                        results += `<p>${index + 1}. Robot rolled: <span class="dice">[${dice.join(', ')}]</span> (sequence: ${action.sequenceNumber})</p>`;
                    });
                    
                    const firstRoll = robotRolls[0];
                    const dice = firstRoll.actionData?.rollDice?.dice || [];
                    
                    if (dice[0] === 6 && dice[1] === 6) {
                        results += `<div class="success">üéØ PROOF: Robot roll history fix is working! Dice values are now [6,6] instead of [3,4]</div>`;
                    } else if (dice[0] === 3 && dice[1] === 4) {
                        results += `<div class="error">‚ö†Ô∏è Old bug still present: Robot using default [3,4] dice</div>`;
                    } else {
                        results += `<div class="info">‚ÑπÔ∏è Robot using dice: [${dice.join(', ')}]</div>`;
                    }
                } else {
                    results += `<div class="error">‚ùå ERROR: No robot roll actions found in history</div>`;
                }
                
                // Show all actions for debugging
                results += `<h3>üìã All History Actions:</h3>`;
                results += `<pre>`;
                historyData.actions.forEach((action, index) => {
                    const dice = action.actionData?.rollDice?.dice;
                    const diceText = dice ? ` - dice: [${dice.join(', ')}]` : '';
                    results += `${index + 1}. ${action.actionType} (seq: ${action.sequenceNumber})${diceText}\n`;
                });
                results += `</pre>`;
                
                resultsDiv.innerHTML = results;
                statusDiv.innerHTML = '‚úÖ Verification complete!';
                
            } catch (error) {
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
                resultsDiv.innerHTML = `<div class="error">Verification failed: ${error.message}</div>`;
            }
        }
        
        // Start verification when page loads
        window.onload = verifyRobotHistoryFix;
    </script>
</body>
</html>